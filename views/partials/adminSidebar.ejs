<div class="admin-sidebar">
  <div class="sidebar-header">
    <a href="/admin/dashboard">
      <img src="/images/logo.svg" alt="PizzazzPizza Admin" class="sidebar-logo">
    </a>
    <h5>Admin Panel</h5>
  </div>
  <ul class="sidebar-menu">
    <li class="has-submenu <%= (typeof page !== 'undefined' && (page === 'dashboard' || page === 'statistics' || page === 'sales')) ? 'active-parent' : '' %>">
      <a href="#" class="menu-toggle">
        <i class="uil uil-estate"></i> Dashboard <i class="uil uil-angle-down submenu-arrow"></i>
      </a>
      <ul class="submenu" style="display: <%= (typeof page !== 'undefined' && (page === 'dashboard' || page === 'statistics' || page === 'sales')) ? 'block' : 'none' %>;">
        <li>
          <a href="/admin/dashboard" class="<%= typeof page !== 'undefined' && page === 'dashboard' ? 'active' : '' %>">
            <i class="uil uil-apps"></i> Welcome
          </a>
        </li>
        <li>
          <a href="/admin/statistics/dashboard" class="<%= typeof page !== 'undefined' && page === 'statistics' ? 'active' : '' %>">
            <i class="uil uil-graph-bar"></i> Statistics
          </a>
        </li>
        <li>
          <a href="/admin/sales/dashboard" class="<%= typeof page !== 'undefined' && page === 'sales' ? 'active' : '' %>">
            <i class="uil uil-bill"></i> Sales
          </a>
        </li>
      </ul>
    </li>
    <li>
      <a href="/admin/users" class="<%= typeof page !== 'undefined' && page === 'users' ? 'active' : '' %>">
        <i class="uil uil-users-alt"></i> User Management
      </a>
    </li>
    <li>
      <a href="/admin/menu" class="<%= typeof page !== 'undefined' && page === 'menu' ? 'active' : '' %>">
        <i class="uil uil-restaurant"></i> Menu Management
      </a>
    </li>
    <li>
      <a href="/admin/ordersManagement" class="<%= typeof page !== 'undefined' && page === 'orders' ? 'active' : '' %>">
        <i class="uil uil-clipboard-notes"></i> Orders Management
      </a>
    </li>
    <li>
      <a href="/admin/banners" class="<%= typeof page !== 'undefined' && page === 'banners' ? 'active' : '' %>">
        <i class="uil uil-images"></i> Promotion Banners
      </a>
    </li>
  </ul>
  <div class="sidebar-logout">
    <a href="/admin/logout"> Logout </a>
  </div>
</div>

<style>
  /* Add some basic styling for the submenu and toggle */
  .admin-sidebar .sidebar-menu li.has-submenu>a {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .admin-sidebar .sidebar-menu .submenu {
    list-style: none;
    padding-left: 20px;
    /* Indent submenu items */
    /* display: none; */
    /* Initially hidden, controlled by JS or inline style */
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .admin-sidebar .sidebar-menu .submenu.open {
    /* display: block; */
    /* Show when open class is added */
    max-height: 500px;
    /* Adjust as needed to fit content */
  }

  .admin-sidebar .sidebar-menu .submenu a {
    padding-left: 25px;
    /* Further indent text of submenu items */
    font-size: 0.9em;
  }

  .admin-sidebar .sidebar-menu .submenu a i {
    margin-right: 8px;
  }

  .admin-sidebar .sidebar-menu .submenu-arrow {
    transition: transform 0.3s ease;
  }

  .admin-sidebar .sidebar-menu li.has-submenu.open>a>.submenu-arrow {
    transform: rotate(180deg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggles = document.querySelectorAll('.admin-sidebar .menu-toggle');
    const dashboardSubmenuStateKey = 'dashboardSubmenuState'; // localStorage key

    menuToggles.forEach(toggle => {
      // Assuming this script primarily targets the "Dashboard" submenu,
      // as it's the only one with class "has-submenu" in the provided HTML.
      // If other submenus are added, this logic would apply to them individually
      // and might need distinct localStorage keys.

      const parentLi = toggle.parentElement;
      const submenu = toggle.nextElementSibling;

      if (!submenu || !parentLi.classList.contains('has-submenu')) {
        return;
      }

      const applyState = (isOpen, useTransition = false) => {
        if (isOpen) {
          parentLi.classList.add('open');
          submenu.classList.add('open');
          submenu.style.display = 'block'; // Ensure display is block for scrollHeight

          // Use a timeout to allow display:block to take effect before measuring scrollHeight
          setTimeout(() => {
            const currentScrollHeight = submenu.scrollHeight;
            if (useTransition) {
              submenu.style.maxHeight = (currentScrollHeight > 0 ? currentScrollHeight : 500) + "px"; // Fallback to 500px
            } else {
              // No transition on initial load if already open
              submenu.style.maxHeight = (currentScrollHeight > 0 ? currentScrollHeight : 500) + "px";
            }
            // console.log('Applied OPEN state. maxHeight:', submenu.style.maxHeight);
          }, useTransition ? 0 : 50); // Shorter delay for click, longer for initial load
        } else {
          if (useTransition) {
            submenu.style.maxHeight = '0';
          } else {
            // No transition on initial load if closed
            submenu.style.maxHeight = '0';
          }
          parentLi.classList.remove('open');
          submenu.classList.remove('open');
          // Note: display:none could be set after transition, but max-height:0 and overflow:hidden usually suffice.
          // console.log('Applied CLOSED state. maxHeight:', submenu.style.maxHeight);
        }
      };

      // Initialize state from localStorage or EJS default
      const savedState = localStorage.getItem(dashboardSubmenuStateKey);

      if (savedState === 'open') {
        // console.log('localStorage: open');
        applyState(true, false); // Open without transition on load
      } else if (savedState === 'closed') {
        // console.log('localStorage: closed');
        applyState(false, false); // Close without transition on load
      } else {
        // No saved state, use EJS default (based on inline style for display)
        const isEjsOpen = submenu.style.display === 'block';
        // console.log('localStorage: none. EJS open:', isEjsOpen);
        applyState(isEjsOpen, false); // Apply EJS state without transition
        // Optionally, save this default state to localStorage
        // localStorage.setItem(dashboardSubmenuStateKey, isEjsOpen ? 'open' : 'closed');
      }

      // Click event listener for toggling
      toggle.addEventListener('click', function(event) {
        event.preventDefault();
        const currentlyOpen = submenu.classList.contains('open');
        // console.log('Toggle CLICK. Currently open:', currentlyOpen);

        if (currentlyOpen) { // If currently open, then close it
          applyState(false, true); // Close with transition
          localStorage.setItem(dashboardSubmenuStateKey, 'closed');
        } else { // If currently closed, then open it
          applyState(true, true); // Open with transition
          localStorage.setItem(dashboardSubmenuStateKey, 'open');
        }
      });
    });
  });
</script>